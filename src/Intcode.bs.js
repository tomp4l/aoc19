// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var Int64 = require("bs-platform/lib/js/int64.js");
var Caml_obj = require("bs-platform/lib/js/caml_obj.js");
var Caml_int64 = require("bs-platform/lib/js/caml_int64.js");
var Relude_Map = require("relude/src/Relude_Map.bs.js");
var Caml_format = require("bs-platform/lib/js/caml_format.js");
var Relude_List = require("relude/src/Relude_List.bs.js");
var Relude_Option = require("relude/src/Relude_Option.bs.js");
var Relude_String = require("relude/src/Relude_String.bs.js");
var Readline$Aoc19 = require("./lib/Readline.bs.js");
var Caml_exceptions = require("bs-platform/lib/js/caml_exceptions.js");
var Relude_Function = require("relude/src/Relude_Function.bs.js");
var Relude_Ordering = require("relude/src/Relude_Ordering.bs.js");
var StackSafeFuture$Aoc19 = require("./lib/StackSafeFuture.bs.js");

function compare(a, b) {
  return Relude_Ordering.fromInt(Int64.compare(a, b));
}

var eq = Caml_obj.caml_equal;

var $$Map = Relude_Map.WithOrd({
      eq: eq,
      compare: compare
    });

function fromList(list) {
  return Relude_List.foldLeft((function (map, param) {
                  return Curry._3($$Map.set, Caml_int64.of_int32(param[1]), param[0], map);
                }), Curry._1($$Map.make, /* () */0))(Relude_List.zipWithIndex(list));
}

function get(i) {
  return Curry._2(Relude_Function.flipCompose, Curry._1($$Map.get, i), (function (param) {
                return Relude_Option.getOrElse("0", param);
              }));
}

var set = $$Map.set;

function getFromMemory(m) {
  return Curry._2(Relude_Function.flipCompose, Curry._1($$Map.get, Caml_format.caml_int64_of_string(m)), (function (param) {
                return Relude_Option.getOrElse("0", param);
              }));
}

var UnknownMode = Caml_exceptions.create("Intcode-Aoc19.ComputerState.UnknownMode");

var asNumber = Caml_format.caml_int64_of_string;

function fromList$1(list) {
  return {
          memory: fromList(list),
          pointer: /* int64 */{
            hi: 0,
            lo: 0
          },
          relativeBase: /* int64 */{
            hi: 0,
            lo: 0
          }
        };
}

function get$1(param) {
  var memory = param.memory;
  var pointer = param.pointer;
  return Curry._1(get(pointer), memory);
}

function increment(state) {
  state.pointer = Caml_int64.add(state.pointer, /* int64 */{
        hi: 0,
        lo: 1
      });
  return /* () */0;
}

function incrementAndGet(state) {
  var v = get$1(state);
  increment(state);
  return v;
}

function incrementAndGetWithMode(mode, state) {
  var v = incrementAndGet(state);
  switch (mode) {
    case "0" :
        var p = v;
        var param = state;
        return Curry._1(getFromMemory(p), param.memory);
    case "1" :
        return v;
    case "2" :
        var p$1 = v;
        var param$1 = state;
        var memory = param$1.memory;
        var relativeBase = param$1.relativeBase;
        return Curry._1(get(Caml_int64.add(Caml_format.caml_int64_of_string(p$1), relativeBase)), memory);
    default:
      throw UnknownMode;
  }
}

function incrementAndSetWithMode(mode, value, state) {
  var key = Caml_format.caml_int64_of_string(incrementAndGet(state));
  var cell;
  switch (mode) {
    case "0" :
        cell = key;
        break;
    case "2" :
        cell = Caml_int64.add(key, state.relativeBase);
        break;
    default:
      throw UnknownMode;
  }
  state.memory = Curry._3(set, cell, value, state.memory);
  return /* () */0;
}

function doOp3(op, param, state) {
  var m2 = param[1];
  var m1 = param[0];
  var l = Relude_Function.flipCompose((function (param) {
          return incrementAndGetWithMode(m1, param);
        }), asNumber, state);
  var r = Relude_Function.flipCompose((function (param) {
          return incrementAndGetWithMode(m2, param);
        }), asNumber, state);
  var value = Int64.to_string(Curry._2(op, l, r));
  incrementAndSetWithMode(param[2], value, state);
  return /* Continue */1;
}

function halt(param) {
  return /* Halt */0;
}

function jumpIf(param, nonZero, state) {
  var m2 = param[1];
  var v = incrementAndGetWithMode(param[0], state);
  var p = Relude_Function.flipCompose((function (param) {
          return incrementAndGetWithMode(m2, param);
        }), asNumber, state);
  if (nonZero) {
    if (v !== "0") {
      state.pointer = p;
    }
    
  } else if (v === "0") {
    state.pointer = p;
  }
  return /* Continue */1;
}

function defaultNextInput(param) {
  var readline = Readline$Aoc19.make(/* () */0);
  return StackSafeFuture$Aoc19.tap((function (param) {
                  readline.close();
                  return /* () */0;
                }))(Readline$Aoc19.question(readline, "input dear human\n"));
}

function defaultNextOutput(param) {
  console.log("Output: ", param);
  return /* () */0;
}

function run($staropt$star, $staropt$star$1, intcode) {
  var nextInput = $staropt$star !== undefined ? $staropt$star : defaultNextInput;
  var nextOutput = $staropt$star$1 !== undefined ? $staropt$star$1 : defaultNextOutput;
  var state = fromList$1(intcode);
  var program = function (_param) {
    while(true) {
      var op = incrementAndGet(state);
      var padded = Relude_String.repeat(4, "0") + op;
      var split = Relude_List.reverse(Relude_String.splitList("", padded));
      var nextOp;
      var exit = 0;
      if (split) {
        switch (split[0]) {
          case "1" :
              var match = split[1];
              if (match && match[0] === "0") {
                var match$1 = match[1];
                if (match$1) {
                  var match$2 = match$1[1];
                  if (match$2) {
                    var match$3 = match$2[1];
                    if (match$3) {
                      var partial_arg_000 = match$1[0];
                      var partial_arg_001 = match$2[0];
                      var partial_arg_002 = match$3[0];
                      var partial_arg = /* tuple */[
                        partial_arg_000,
                        partial_arg_001,
                        partial_arg_002
                      ];
                      nextOp = (function(partial_arg){
                      return function (param) {
                        var param$1 = partial_arg;
                        var param$2 = param;
                        return doOp3(Caml_int64.add, param$1, param$2);
                      }
                      }(partial_arg));
                    } else {
                      exit = 1;
                    }
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "2" :
              var match$4 = split[1];
              if (match$4 && match$4[0] === "0") {
                var match$5 = match$4[1];
                if (match$5) {
                  var match$6 = match$5[1];
                  if (match$6) {
                    var match$7 = match$6[1];
                    if (match$7) {
                      var partial_arg_000$1 = match$5[0];
                      var partial_arg_001$1 = match$6[0];
                      var partial_arg_002$1 = match$7[0];
                      var partial_arg$1 = /* tuple */[
                        partial_arg_000$1,
                        partial_arg_001$1,
                        partial_arg_002$1
                      ];
                      nextOp = (function(partial_arg$1){
                      return function (param) {
                        var param$1 = partial_arg$1;
                        var param$2 = param;
                        return doOp3(Caml_int64.mul, param$1, param$2);
                      }
                      }(partial_arg$1));
                    } else {
                      exit = 1;
                    }
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "3" :
              var match$8 = split[1];
              if (match$8 && match$8[0] === "0") {
                var match$9 = match$8[1];
                if (match$9) {
                  var mode = match$9[0];
                  nextOp = (function(mode){
                  return function (param) {
                    var nextInput$1 = nextInput;
                    var mode$1 = mode;
                    var state = param;
                    var input = Curry._1(nextInput$1, /* () */0);
                    var processed = StackSafeFuture$Aoc19.map((function (v) {
                            return incrementAndSetWithMode(mode$1, v, state);
                          }), input);
                    return /* AwaitInput */[processed];
                  }
                  }(mode));
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "4" :
              var match$10 = split[1];
              if (match$10 && match$10[0] === "0") {
                var match$11 = match$10[1];
                if (match$11) {
                  var mode$1 = match$11[0];
                  nextOp = (function(mode$1){
                  return function (param) {
                    var nextOutput$1 = nextOutput;
                    var mode$2 = mode$1;
                    var state = param;
                    var v = incrementAndGetWithMode(mode$2, state);
                    Curry._1(nextOutput$1, v);
                    return /* Continue */1;
                  }
                  }(mode$1));
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "5" :
              var match$12 = split[1];
              if (match$12 && match$12[0] === "0") {
                var match$13 = match$12[1];
                if (match$13) {
                  var match$14 = match$13[1];
                  if (match$14) {
                    var partial_arg_000$2 = match$13[0];
                    var partial_arg_001$2 = match$14[0];
                    var partial_arg$2 = /* tuple */[
                      partial_arg_000$2,
                      partial_arg_001$2
                    ];
                    nextOp = (function(partial_arg$2){
                    return function (param) {
                      return jumpIf(partial_arg$2, true, param);
                    }
                    }(partial_arg$2));
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "6" :
              var match$15 = split[1];
              if (match$15 && match$15[0] === "0") {
                var match$16 = match$15[1];
                if (match$16) {
                  var match$17 = match$16[1];
                  if (match$17) {
                    var partial_arg_000$3 = match$16[0];
                    var partial_arg_001$3 = match$17[0];
                    var partial_arg$3 = /* tuple */[
                      partial_arg_000$3,
                      partial_arg_001$3
                    ];
                    nextOp = (function(partial_arg$3){
                    return function (param) {
                      return jumpIf(partial_arg$3, false, param);
                    }
                    }(partial_arg$3));
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "7" :
              var match$18 = split[1];
              if (match$18 && match$18[0] === "0") {
                var match$19 = match$18[1];
                if (match$19) {
                  var match$20 = match$19[1];
                  if (match$20) {
                    var match$21 = match$20[1];
                    if (match$21) {
                      var partial_arg_000$4 = match$19[0];
                      var partial_arg_001$4 = match$20[0];
                      var partial_arg_002$2 = match$21[0];
                      var partial_arg$4 = /* tuple */[
                        partial_arg_000$4,
                        partial_arg_001$4,
                        partial_arg_002$2
                      ];
                      nextOp = (function(partial_arg$4){
                      return function (param) {
                        var param$1 = partial_arg$4;
                        var param$2 = param;
                        return doOp3((function (a, b) {
                                      if (Int64.compare(a, b) < 0) {
                                        return /* int64 */{
                                                hi: 0,
                                                lo: 1
                                              };
                                      } else {
                                        return /* int64 */{
                                                hi: 0,
                                                lo: 0
                                              };
                                      }
                                    }), param$1, param$2);
                      }
                      }(partial_arg$4));
                    } else {
                      exit = 1;
                    }
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "8" :
              var match$22 = split[1];
              if (match$22 && match$22[0] === "0") {
                var match$23 = match$22[1];
                if (match$23) {
                  var match$24 = match$23[1];
                  if (match$24) {
                    var match$25 = match$24[1];
                    if (match$25) {
                      var partial_arg_000$5 = match$23[0];
                      var partial_arg_001$5 = match$24[0];
                      var partial_arg_002$3 = match$25[0];
                      var partial_arg$5 = /* tuple */[
                        partial_arg_000$5,
                        partial_arg_001$5,
                        partial_arg_002$3
                      ];
                      nextOp = (function(partial_arg$5){
                      return function (param) {
                        var param$1 = partial_arg$5;
                        var param$2 = param;
                        return doOp3((function (a, b) {
                                      if (Caml_int64.eq(a, b)) {
                                        return /* int64 */{
                                                hi: 0,
                                                lo: 1
                                              };
                                      } else {
                                        return /* int64 */{
                                                hi: 0,
                                                lo: 0
                                              };
                                      }
                                    }), param$1, param$2);
                      }
                      }(partial_arg$5));
                    } else {
                      exit = 1;
                    }
                  } else {
                    exit = 1;
                  }
                } else {
                  exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          case "9" :
              var match$26 = split[1];
              if (match$26) {
                switch (match$26[0]) {
                  case "0" :
                      var match$27 = match$26[1];
                      if (match$27) {
                        var partial_arg$6 = match$27[0];
                        nextOp = (function(partial_arg$6){
                        return function (param) {
                          var mode = partial_arg$6;
                          var state = param;
                          var v = Relude_Function.flipCompose((function (param) {
                                  return incrementAndGetWithMode(mode, param);
                                }), asNumber, state);
                          state.relativeBase = Caml_int64.add(state.relativeBase, v);
                          return /* Continue */1;
                        }
                        }(partial_arg$6));
                      } else {
                        exit = 1;
                      }
                      break;
                  case "9" :
                      nextOp = halt;
                      break;
                  default:
                    exit = 1;
                }
              } else {
                exit = 1;
              }
              break;
          default:
            exit = 1;
        }
      } else {
        exit = 1;
      }
      if (exit === 1) {
        console.error("Unknown op", op);
        nextOp = halt;
      }
      var $$continue = Curry._1(nextOp, state);
      if (typeof $$continue === "number") {
        if ($$continue !== 0) {
          _param = /* () */0;
          continue ;
        } else {
          return StackSafeFuture$Aoc19.pure(/* () */0);
        }
      } else {
        return Curry._2(StackSafeFuture$Aoc19.flatMap, program, $$continue[0]);
      }
    };
  };
  var done_ = program(/* () */0);
  return StackSafeFuture$Aoc19.map((function (param) {
                state.pointer = /* int64 */{
                  hi: 0,
                  lo: 0
                };
                return get$1(state);
              }), done_);
}

exports.run = run;
/* Map Not a pure module */
